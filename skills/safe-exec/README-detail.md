# SafeExec è¯¦ç»†æ–‡æ¡£

> å®Œæ•´çš„ä½¿ç”¨æŒ‡å—ã€é…ç½®è¯´æ˜ã€å¼€å‘æ–‡æ¡£å’Œå¸¸è§é—®é¢˜

**ä¸»æ–‡æ¡£ï¼š** [README.md](README.md) | **å˜æ›´æ—¥å¿—ï¼š** [CHANGELOG.md](CHANGELOG.md)

---

## ğŸ“‘ ç›®å½•

- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
  - [å·¥ä½œåŸç†](#å·¥ä½œåŸç†)
  - [æ‰¹å‡†å·¥ä½œæµ](#æ‰¹å‡†å·¥ä½œæµ)
  - [é£é™©ç­‰çº§è¯¦è§£](#é£é™©ç­‰çº§è¯¦è§£)
  - [å…¨å±€æ§åˆ¶](#å…¨å±€æ§åˆ¶)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)
  - [ç¯å¢ƒå˜é‡](#ç¯å¢ƒå˜é‡)
  - [è‡ªå®šä¹‰è§„åˆ™](#è‡ªå®šä¹‰è§„åˆ™)
  - [éäº¤äº’å¼æ¨¡å¼](#éäº¤äº’å¼æ¨¡å¼)
- [å¼€å‘æ–‡æ¡£](#å¼€å‘æ–‡æ¡£)
  - [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
  - [æ–‡ä»¶è¯´æ˜](#æ–‡ä»¶è¯´æ˜)
  - [API å‚è€ƒ](#api-å‚è€ƒ)
  - [è´¡çŒ®æŒ‡å—](#è´¡çŒ®æŒ‡å—)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ä½¿ç”¨æŒ‡å—

### å·¥ä½œåŸç†

SafeExec é€šè¿‡ä»¥ä¸‹æ­¥éª¤ä¿æŠ¤ä½ çš„ç³»ç»Ÿï¼š

```
1. å‘½ä»¤æ‹¦æˆª
   â†“
2. æ¨¡å¼åŒ¹é…
   â†“
3. é£é™©è¯„ä¼°
   â†“
4. å†³ç­–
   â”œâ”€â”€ å®‰å…¨ â†’ ç›´æ¥æ‰§è¡Œ
   â””â”€â”€ å±é™© â†’ è¯·æ±‚æ‰¹å‡†
```

#### æ¶æ„ç»„ä»¶

```
~/.openclaw/safe-exec/
â”œâ”€â”€ pending/              # å¾…å¤„ç†çš„æ‰¹å‡†è¯·æ±‚
â”‚   â””â”€â”€ req_*.json       # è¯·æ±‚è¯¦æƒ…æ–‡ä»¶
â”œâ”€â”€ safe-exec-rules.json # è§„åˆ™é…ç½®æ–‡ä»¶
â””â”€â”€ safe-exec-audit.log  # å®¡è®¡æ—¥å¿—

~/.openclaw/safe-exec-known-*.txt  # ç›‘æ§è¿½è¸ªæ–‡ä»¶
```

### æ‰¹å‡†å·¥ä½œæµ

#### 1. å±é™©å‘½ä»¤æ£€æµ‹

å½“ Agent å°è¯•æ‰§è¡Œå±é™©å‘½ä»¤æ—¶ï¼š

```
ğŸš¨ **å±é™©æ“ä½œæ£€æµ‹ - å‘½ä»¤å·²æ‹¦æˆª**

**é£é™©ç­‰çº§:** CRITICAL
**å‘½ä»¤:** `rm -rf /tmp/test`
**åŸå› :** é€’å½’åˆ é™¤ï¼Œä½¿ç”¨ force æ ‡å¿—

**è¯·æ±‚ ID:** `req_1769938492_9730`

â„¹ï¸  æ­¤å‘½ä»¤éœ€è¦ç”¨æˆ·æ‰¹å‡†æ‰èƒ½æ‰§è¡Œã€‚

**æ‰¹å‡†æ–¹æ³•:**
1. åœ¨ç»ˆç«¯è¿è¡Œ: `safe-exec-approve req_1769938492_9730`
2. æˆ–è€…: `safe-exec-list` æŸ¥çœ‹æ‰€æœ‰å¾…å¤„ç†è¯·æ±‚

**æ‹’ç»æ–¹æ³•:**
 `safe-exec-reject req_1769938492_9730`
```

#### 2. æ‰¹å‡†è¯·æ±‚

```bash
# æ–¹æ³• 1: ä½¿ç”¨è¯·æ±‚ ID
safe-exec-approve req_1769938492_9730

# æ–¹æ³• 2: åˆ—å‡ºå¹¶æ‰¹å‡†æœ€è¿‘çš„è¯·æ±‚
safe-exec-list
# è¾“å‡ºæ‰€æœ‰å¾…å¤„ç†çš„è¯·æ±‚ï¼Œç„¶åä½¿ç”¨ ID æ‰¹å‡†
```

#### 3. å‘½ä»¤æ‰§è¡Œ

æ‰¹å‡†åï¼Œå‘½ä»¤ä¼šæ‰§è¡Œå¹¶è®°å½•åˆ°å®¡è®¡æ—¥å¿—ã€‚

### é£é™©ç­‰çº§è¯¦è§£

#### ğŸ”´ CRITICALï¼ˆå±æ€¥ï¼‰

ç³»ç»Ÿç ´åæ€§å‘½ä»¤ï¼Œéœ€è¦æ˜ç¡®æ‰¹å‡†ï¼š

- `rm -rf /` - åˆ é™¤æ ¹ç›®å½•
- `dd if=/dev/zero` - ç£ç›˜è¦†ç›–
- `mkfs.*` - æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ
- `:(){ :|:& };:` - Fork bomb
- `> /dev/sda` - ç›´æ¥å†™å…¥ç£ç›˜

#### ğŸŸ  HIGHï¼ˆé«˜å±ï¼‰

å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–ç³»ç»Ÿå˜åŠ¨çš„å‘½ä»¤ï¼š

- `rm -rf` (éæ ¹ç›®å½•) - é€’å½’åˆ é™¤
- `chmod 777` - è®¾ç½®å…¨å±€å¯å†™æƒé™
- `curl | bash` - ç®¡é“ä¸‹è½½åˆ° shell
- å†™å…¥ `/etc/`, `/boot/`, `/sys/` - ç³»ç»Ÿç›®å½•ä¿®æ”¹
- `wget | sh` - ä¸‹è½½å¹¶æ‰§è¡Œè„šæœ¬

#### ğŸŸ¡ MEDIUMï¼ˆä¸­å±ï¼‰

éœ€è¦ç‰¹æƒæˆ–å½±å“ç³»ç»Ÿçš„æ“ä½œï¼š

- `sudo` - ä½¿ç”¨ç‰¹æƒæ‰§è¡Œ
- `iptables`, `firewall-cmd`, `ufw` - é˜²ç«å¢™ä¿®æ”¹
- `systemctl` - æœåŠ¡ç®¡ç†
- `crontab -e` - å®šæ—¶ä»»åŠ¡ç¼–è¾‘

#### ğŸŸ¢ LOWï¼ˆä½å±ï¼‰

ç›¸å¯¹å®‰å…¨çš„æ“ä½œï¼Œå¯èƒ½æ— éœ€æ‰¹å‡†ï¼š

- `ls`, `cat`, `grep` - è¯»å–æ“ä½œ
- `cp`, `mv` (éç³»ç»Ÿç›®å½•) - æ–‡ä»¶æ“ä½œ
- `mkdir`, `touch` - åˆ›å»ºæ“ä½œ
- `cd`, `pwd` - å¯¼èˆªæ“ä½œ

### å…¨å±€æ§åˆ¶

#### å¯ç”¨/ç¦ç”¨ SafeExec

**å¯¹è¯å¼ï¼š**
```
Enable SafeExec   # å¯ç”¨
Disable SafeExec  # ç¦ç”¨
```

**è„šæœ¬å¼ï¼š**
```bash
~/.openclaw/skills/safe-exec/safe-exec.sh --enable
~/.openclaw/skills/safe-exec/safe-exec.sh --disable
```

**ç¯å¢ƒå˜é‡ï¼š**
```bash
export SAFE_EXEC_DISABLE=1  # ç¦ç”¨
unset SAFE_EXEC_DISABLE     # å¯ç”¨
```

#### æŸ¥çœ‹çŠ¶æ€

```bash
# æŸ¥çœ‹å¾…å¤„ç†çš„è¯·æ±‚
safe-exec-list

# æŸ¥çœ‹å®¡è®¡æ—¥å¿—ï¼ˆæœ€è¿‘ 50 æ¡ï¼‰
tail -n 50 ~/.openclaw/safe-exec-audit.log

# æŸ¥çœ‹é…ç½®
cat ~/.openclaw/safe-exec-rules.json
```

---

## é«˜çº§é…ç½®

### ç¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `SAFE_EXEC_DISABLE` | å…¨å±€ç¦ç”¨ SafeExec | æœªè®¾ç½® |
| `OPENCLAW_AGENT_CALL` | æ ‡è¯† Agent è°ƒç”¨ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰ | è‡ªåŠ¨ |
| `SAFE_EXEC_AUTO_CONFIRM` | è‡ªåŠ¨æ‰¹å‡† LOW/MEDIUM é£é™© | æœªè®¾ç½® |
| `SAFEXEC_CONTEXT` | ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ | ç©º |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```bash
# è‡ªåŠ¨æ‰¹å‡†ä½ä¸­é£é™©å‘½ä»¤
export SAFE_EXEC_AUTO_CONFIRM=1

# åœ¨ Agent ä¸­ä½¿ç”¨ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
export OPENCLAW_AGENT_CALL=1

# å®Œå…¨ç¦ç”¨
export SAFE_EXEC_DISABLE=1
```

### è‡ªå®šä¹‰è§„åˆ™

ç¼–è¾‘ `~/.openclaw/safe-exec-rules.json`ï¼š

```json
{
  "enabled": true,
  "rules": [
    {
      "pattern": "docker rm.*-f",
      "risk": "medium",
      "reason": "å¼ºåˆ¶åˆ é™¤ Docker å®¹å™¨"
    },
    {
      "pattern": "kubectl delete",
      "risk": "high",
      "reason": "åˆ é™¤ Kubernetes èµ„æº"
    }
  ]
}
```

### éäº¤äº’å¼æ¨¡å¼

åœ¨éäº¤äº’å¼ç¯å¢ƒï¼ˆå¦‚ Agent è°ƒç”¨ï¼‰ä¸­ï¼š

1. **TTY æ£€æµ‹**ï¼šSafeExec è‡ªåŠ¨æ£€æµ‹æ˜¯å¦åœ¨äº¤äº’å¼ç»ˆç«¯
2. **ç¯å¢ƒæ£€æµ‹**ï¼šæ£€æµ‹ `OPENCLAW_AGENT_CALL` ç¯å¢ƒå˜é‡
3. **æ™ºèƒ½è·³è¿‡**ï¼šåœ¨éäº¤äº’å¼ç¯å¢ƒä¸­è·³è¿‡äºŒæ¬¡ç¡®è®¤

```bash
# Agent è°ƒç”¨æ—¶è‡ªåŠ¨å¯ç”¨éäº¤äº’æ¨¡å¼
export OPENCLAW_AGENT_CALL=1
```

---

## å¼€å‘æ–‡æ¡£

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  safe-exec.sh    â”‚ â† ä¸»å…¥å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é£é™©è¯„ä¼°å¼•æ“      â”‚
â”‚  - æ¨¡å¼åŒ¹é…        â”‚
â”‚  - ä¸Šä¸‹æ–‡åˆ†æ      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚ å±é™©ï¼Ÿ  â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     æ˜¯ â”‚   â”‚ å¦
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç›´æ¥æ‰§è¡Œ
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚æ‰¹å‡†     â”‚
â”‚ - å†™å…¥ pendingâ”‚
â”‚ - é€šçŸ¥ç”¨æˆ·   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–‡ä»¶è¯´æ˜

#### æ ¸å¿ƒè„šæœ¬

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `safe-exec.sh` | ä¸»æ‰§è¡Œè„šæœ¬ï¼Œå‘½ä»¤æ‹¦æˆªå’Œé£é™©è¯„ä¼° |
| `safe-exec-approve.sh` | æ‰¹å‡†è¯·æ±‚çš„è„šæœ¬ |
| `safe-exec-reject.sh` | æ‹’ç»è¯·æ±‚çš„è„šæœ¬ |
| `safe-exec-list.sh` | åˆ—å‡ºå¾…å¤„ç†çš„è¯·æ±‚ |
| `safe-exec-check-pending.sh` | æ£€æŸ¥å¾…å¤„ç†è¯·æ±‚ |

#### æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `README.md` | ä¸»è¦æ–‡æ¡£ï¼Œå¿«é€Ÿå¼€å§‹ |
| `README-detail.md` | æœ¬æ–‡æ¡£ï¼Œè¯¦ç»†è¯´æ˜ |
| `CHANGELOG.md` | ç‰ˆæœ¬å˜æ›´æ—¥å¿— |
| `SKILL.md` | ClawdHub skill æè¿° |
| `CONTRIBUTING.md` | è´¡çŒ®æŒ‡å— |

#### é…ç½®å’Œæ•°æ®

| æ–‡ä»¶/ç›®å½• | è¯´æ˜ |
|-----------|------|
| `~/.openclaw/safe-exec-rules.json` | è§„åˆ™é…ç½® |
| `~/.openclaw/safe-exec-audit.log` | å®¡è®¡æ—¥å¿— |
| `~/.openclaw/safe-exec/pending/` | å¾…å¤„ç†è¯·æ±‚ |

### API å‚è€ƒ

#### safe-exec.sh

```bash
# æ‰§è¡Œå‘½ä»¤
safe-exec.sh "command"

# å¯ç”¨/ç¦ç”¨
safe-exec.sh --enable
safe-exec.sh --disable
safe-exec.sh --status
```

#### safe-exec-approve.sh

```bash
# æ‰¹å‡†è¯·æ±‚
safe-exec-approve.sh <request_id>

# æŸ¥çœ‹è¯¦æƒ…
safe-exec-approve.sh --list
```

#### safe-exec-list.sh

```bash
# åˆ—å‡ºæ‰€æœ‰å¾…å¤„ç†è¯·æ±‚
safe-exec-list.sh

# ä»…æ˜¾ç¤º CRITICAL çº§åˆ«
safe-exec-list.sh --critical
```

### è´¡çŒ®æŒ‡å—

#### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# 1. Fork å¹¶å…‹éš†ä»“åº“
git clone https://github.com/OTTTTTO/safe-exec.git
cd safe-exec

# 2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/my-feature

# 3. æµ‹è¯•ä¿®æ”¹
./test-safeexec.sh

# 4. æäº¤æ›´æ”¹
git commit -m "feat: Add my feature"

# 5. æ¨é€å¹¶åˆ›å»º PR
git push origin feature/my-feature
```

#### ä»£ç è§„èŒƒ

- Bash è„šæœ¬éµå¾ª [ShellCheck](https://www.shellcheck.net/) å»ºè®®
- æ–‡æ¡£ä½¿ç”¨ Markdown æ ¼å¼
- æäº¤ä¿¡æ¯éµå¾ª [Conventional Commits](https://www.conventionalcommits.org/)

#### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./test-safeexec.sh

# è¿è¡Œç‰¹å®šæµ‹è¯•
./test-regression.sh
./test-context-aware.sh
```

---

## å¸¸è§é—®é¢˜

### æ•…éšœæ’æŸ¥

#### Q: SafeExec æ²¡æœ‰æ‹¦æˆªå‘½ä»¤

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. æ˜¯å¦å·²å¯ç”¨ï¼Ÿ
```bash
~/.openclaw/skills/safe-exec/safe-exec.sh --status
```

2. æ˜¯å¦è¢«ç¯å¢ƒå˜é‡ç¦ç”¨ï¼Ÿ
```bash
echo $SAFE_EXEC_DISABLE
```

3. å‘½ä»¤æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼Ÿ

#### Q: æ‰¹å‡†å‘½ä»¤åæ²¡æœ‰æ‰§è¡Œ

**A:** å¯èƒ½çš„åŸå› ï¼š

1. è¯·æ±‚å·²è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
2. å‘½ä»¤è¯­æ³•é”™è¯¯
3. æƒé™ä¸è¶³

æŸ¥çœ‹å®¡è®¡æ—¥å¿—ï¼š
```bash
tail -f ~/.openclaw/safe-exec-audit.log
```

#### Q: å¦‚ä½•é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Ÿ

**A:** åˆ é™¤æ•°æ®æ–‡ä»¶ï¼š
```bash
rm -rf ~/.openclaw/safe-exec/
rm ~/.openclaw/safe-exec-*
```

### æœ€ä½³å®è·µ

#### 1. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

```bash
# å¯ç”¨è‡ªåŠ¨ç¡®è®¤ä½ä¸­é£é™©æ“ä½œ
export SAFE_EXEC_AUTO_CONFIRM=1

# å®šæœŸå¤‡ä»½å®¡è®¡æ—¥å¿—
cp ~/.openclaw/safe-exec-audit.log ~/.backup/
```

#### 2. å¤šç”¨æˆ·ç¯å¢ƒ

ä¸ºæ¯ä¸ªç”¨æˆ·é…ç½®ç‹¬ç«‹çš„è§„åˆ™æ–‡ä»¶ï¼š
```bash
export SAFE_EXEC_RULES_FILE="/home/user/.safe-exec-rules.json"
```

#### 3. ä¸å…¶ä»–å·¥å…·é›†æˆ

**ä¸ sudo é›†æˆï¼š**
```bash
# åœ¨ sudoers ä¸­æ·»åŠ 
Defaults secure_path = /usr/local/bin:/usr/bin:/bin
```

**ä¸æ—¥å¿—ç³»ç»Ÿé›†æˆï¼š**
```bash
# å°†å®¡è®¡æ—¥å¿—å‘é€åˆ° rsyslog
tail -f ~/.openclaw/safe-exec-audit.log | logger -t safeexec
```

### æ€§èƒ½ä¼˜åŒ–

#### å‡å°‘å»¶è¿Ÿ

```bash
# ä½¿ç”¨æ›´å¿«çš„ç£ç›˜å­˜å‚¨
export SAFE_EXEC_DIR="/dev/shm/safe-exec"
```

#### å®šæœŸæ¸…ç†

```bash
# æ¸…ç†è¿‡æœŸçš„ pending è¯·æ±‚
find ~/.openclaw/safe-exec/pending/ -mtime +1 -delete

# å‹ç¼©æ—§æ—¥å¿—
logrotate ~/.openclaw/safe-exec-audit.log
```

---

## é™„å½•

### ç›¸å…³èµ„æº

- [OpenClaw æ–‡æ¡£](https://docs.openclaw.ai/)
- [ClawdHub å¸‚åœº](https://www.clawhub.ai/skills)
- [Bash æœ€ä½³å®è·µ](https://github.com/koalaman/shellcheck)

### ç¤¾åŒº

- **GitHub Issues**: https://github.com/OTTTTTO/safe-exec/issues
- **Discussions**: https://github.com/OTTTTTO/safe-exec/discussions
- **Email**: 731554297@qq.com

### è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE)

---

**æœ€åæ›´æ–°:** 2026-02-01
**ç»´æŠ¤è€…:** OTTTTTO
**ç‰ˆæœ¬:** v0.3.1
